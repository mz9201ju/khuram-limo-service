<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>PayPal Auto Capture (Debug)</title>
    <style>
        body {
            font-family: system-ui, Segoe UI, Arial;
            padding: 18px;
            background: #fff
        }

        pre {
            white-space: pre-wrap
        }
    </style>
</head>

<body>
    <h2>PayPal Auto Capture (debug)</h2>
    <p>This page extracts <code>token</code> / <code>PayerID</code> from URL and calls your local worker to capture the
        order.</p>
    <p><strong>Note:</strong> open DevTools (F12) â†’ Console / Network for more debug info.</p>
    <hr>
    <p><strong>Worker endpoint:</strong> <span id="worker-url"></span></p>
    <pre id="out">waiting for params...</pre>

    <script>
        (async function () {
            const OUT = document.getElementById('out');
            const WORKER = (window.WORKER_URL = "https://mz9201ju.github.io/khuram-limo-service"); // edit if your worker runs elsewhere
            document.getElementById('worker-url').textContent = WORKER;

            function q(name) {
                try { return new URLSearchParams(location.search).get(name) || ""; } catch (e) { return ""; }
            }

            const token = q('token') || q('orderId') || q('orderID') || q('order_id');
            const payerId = q('PayerID') || q('payerid') || q('PAYERID') || q('PayerId');

            OUT.textContent = `URL: ${location.href}\n\nParsed params:\n token=${token}\n PayerID=${payerId}\n\n`;

            if (!token) {
                OUT.textContent += "ERROR: no token/orderId found in URL. Did PayPal redirect here with ?token=... ?\n";
                return;
            }

            const body = { orderId: token };
            // also include payerId for classic/NVP flows or for logging
            if (payerId) body.payerId = payerId;

            async function doCapture(attempt) {
                OUT.textContent += `Calling ${WORKER}/capture-order (attempt ${attempt})...\n\n`;
                try {
                    const res = await fetch(`${WORKER}/capture-order`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body),
                        cache: 'no-store'
                    });

                    OUT.textContent += `HTTP ${res.status} ${res.statusText}\n\n`;
                    const text = await res.text();
                    // try to pretty-print JSON if possible
                    try { OUT.textContent += JSON.stringify(JSON.parse(text), null, 2); }
                    catch (e) { OUT.textContent += text; }
                    // done
                    return;
                } catch (err) {
                    OUT.textContent += `Network/Fetch error: ${String(err)}\n`;
                    console.error("fetch error:", err);
                    if (attempt === 1) {
                        OUT.textContent += "Retrying in 1s...\n";
                        await new Promise(r => setTimeout(r, 1000));
                        return doCapture(2);
                    } else {
                        OUT.textContent += "Failed after retry. Check worker running and CORS headers.\n";
                    }
                }
            }

            await doCapture(1);
        })();
    </script>
</body>

</html>